# Project Organization

This document describes the organization and structure of the Hyper-NixOS project.

## Directory Structure

```
/
├── flake.nix                    # NixOS flake definition
├── configuration.nix            # Main system configuration
├── hardware-configuration.nix   # Hardware-specific config
├── README.md                    # Project overview
├── LICENSE                      # GPL v3.0 license
│
├── modules/                     # Custom NixOS modules
│   ├── config.json             # Hypervisor configuration
│   ├── vm_profile.schema.json  # VM profile validation schema
│   ├── core/                   # Core system modules (6)
│   ├── security/               # Security modules (6)
│   ├── monitoring/             # Monitoring modules (3)
│   ├── enterprise/             # Enterprise features (6)
│   ├── virtualization/         # Libvirt & KVM (2)
│   ├── gui/                    # Desktop environment (2)
│   ├── web/                    # Web dashboard (1)
│   ├── automation/             # Automation services (2)
│   └── apparmor/               # AppArmor profiles
│
├── scripts/                     # Management scripts (78)
│   ├── menu.sh                 # Main menu system
│   ├── system_installer.sh     # Installation script
│   ├── vm_*.sh                 # VM management scripts
│   ├── *_manager.sh            # Resource managers
│   └── ...                     # Additional utilities
│
├── docs/                        # Documentation
│   ├── README.md               # Documentation index
│   ├── CREDITS.md              # Project credits
│   ├── VERSION                 # Version information
│   ├── ENTERPRISE_QUICK_START.md
│   ├── dev/                    # Development notes
│   │   ├── README.md
│   │   ├── AUDIT_REPORT.md
│   │   └── ...                 # Historical documentation
│   └── ...                     # User guides & tutorials
│
├── tests/                       # Test suite
│   ├── run_all_tests.sh
│   ├── ci_validation.sh
│   ├── integration/            # Integration tests
│   └── lib/                    # Test helpers
│
├── vm_profiles/                 # VM templates (JSON)
├── monitoring/                  # Prometheus/Grafana configs
├── hypervisor_manager/          # Python management tools
├── web/                         # Web dashboard templates
├── isos/                        # ISO storage directory
└── tools/                       # Additional tooling
```

## File Organization Principles

### Root Directory
The root directory contains only essential files for a NixOS flake:
- **flake.nix** - Flake definition and outputs
- **configuration.nix** - Main system configuration
- **hardware-configuration.nix** - Hardware-specific settings
- **README.md** - Project overview
- **LICENSE** - License file

All other files are organized into appropriate subdirectories.

### Modules Directory
Custom NixOS modules are organized by functionality:
- **core/** - Essential system configuration
- **security/** - Security hardening and policies
- **monitoring/** - Prometheus, logging, alerting
- **enterprise/** - Enterprise features (quotas, encryption, etc.)
- **virtualization/** - KVM/QEMU/libvirt configuration
- **gui/** - Desktop environment (optional)
- **web/** - Web dashboard service
- **automation/** - Scheduled tasks and automation

### Documentation Organization
Documentation is structured for different audiences:
- **User Guides** - Located in `docs/` with descriptive names
- **Quick Starts** - `ENTERPRISE_QUICK_START.md`, `QUICK_REFERENCE.md`
- **Development Notes** - All in `docs/dev/` subdirectory
- **Technical Docs** - Architecture and design in `docs/`

## Configuration Files

### Main Configuration
- `configuration.nix` - Imports all modules and defines system services
- `hardware-configuration.nix` - Generated by nixos-generate-config
- `modules/config.json` - Runtime hypervisor configuration
- `modules/vm_profile.schema.json` - VM profile validation

### Local Overrides
Local customizations are stored in `/var/lib/hypervisor/configuration/`:
- `users-local.nix` - User accounts
- `system-local.nix` - System settings
- `security-local.nix` - Security preferences
- `gui-local.nix` - GUI settings
- `perf-local.nix` - Performance tuning

These are conditionally imported if they exist, allowing per-host customization without modifying the base configuration.

## Scripts Organization

Scripts are organized by function:
- **VM Management** - `vm_*.sh` (create, clone, start, stop, etc.)
- **Menus** - `menu.sh`, `management_dashboard.sh`
- **Installation** - `system_installer.sh`, `setup_wizard.sh`
- **Security** - `security_audit.sh`, `quick_security_audit.sh`
- **Health Checks** - `enhanced_health_checks.sh`, `preflight_check.sh`
- **Resource Management** - `*_manager.sh` (quota, snapshot, etc.)
- **VFIO** - `vfio_*.sh` for GPU passthrough

All scripts are executable and follow consistent naming conventions.

## Testing Structure

```
tests/
├── run_all_tests.sh          # Master test runner
├── ci_validation.sh          # CI/CD validation
├── integration/              # Integration tests
│   ├── test_system_installer.sh
│   ├── test_security_model.sh
│   └── test_vm_lifecycle.sh
└── lib/                      # Test helpers
    └── test_helpers.sh
```

## Development Workflow

1. **Flake Changes** - Edit `flake.nix` for inputs/outputs
2. **Module Changes** - Add/modify files in `modules/`
3. **Script Changes** - Update scripts in `scripts/`
4. **Documentation** - Update relevant docs in `docs/`
5. **Testing** - Run tests from `tests/`
6. **Development Notes** - Add to `docs/dev/` as needed

## Best Practices

### File Naming
- **Nix files** - kebab-case (e.g., `kernel-hardening.nix`)
- **Scripts** - snake_case (e.g., `vm_manager.sh`)
- **Documentation** - SCREAMING_SNAKE_CASE for guides, kebab-case for technical docs

### Module Structure
Each module should:
- Have a clear purpose comment at the top
- Define options in an `options` block
- Implement configuration in a `config` block
- Use `lib.mkEnableOption` for optional features
- Use `lib.mkIf` for conditional configuration

### Documentation
- User guides go in `docs/`
- Development notes go in `docs/dev/`
- Each major feature should have documentation
- Code should have inline comments for complex logic

## Related Documentation

- [Main README](../README.md) - Project overview
- [Documentation Index](README.md) - All user documentation
- [Development Notes](dev/README.md) - Historical development documentation
- [Testing Guide](TESTING_GUIDE.md) - How to run and write tests

---

**Last Updated:** 2025-10-13  
**Maintained By:** Hyper-NixOS Team
