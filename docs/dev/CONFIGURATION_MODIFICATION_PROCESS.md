# Hyper-NixOS Configuration Modification Process

## 📋 Overview

This document explains how the Hyper-NixOS wizards, setup scripts, and automation tools modify system configurations to implement changes. Understanding this process is crucial for developers and system administrators.

## 🔧 Configuration Files Structure

### Primary Configuration Files

1. **`/etc/nixos/configuration.nix`**
   - Main NixOS configuration file
   - Imports all other configuration modules
   - Defines base system settings

2. **`/etc/nixos/hypervisor-features.nix`**
   - Generated by feature management wizard
   - Contains enabled features list
   - Feature-specific settings

3. **`/etc/nixos/hypervisor-tier.nix`**
   - Generated by first-boot wizard
   - Defines system tier (minimal, standard, etc.)
   - Hardware-optimized settings

4. **`/etc/nixos/hardware-configuration.nix`**
   - Auto-generated hardware settings
   - Boot configuration
   - Filesystem mounts

## 🔄 Configuration Modification Process

### 1. Detection Phase

```bash
# System detection runs first
hv-detect-system json > /tmp/system-info.json

# Extract capabilities
CAPABILITIES=$(jq '.capabilities' /tmp/system-info.json)
HARDWARE=$(jq '.hardware' /tmp/system-info.json)
```

The detection phase:
- Queries hardware (CPU, RAM, GPU, storage)
- Checks virtualization capabilities
- Detects special features (IOMMU, ECC RAM)
- Identifies network configuration
- Caches results for performance

### 2. Validation Phase

Before any modifications:

```bash
# Check feature compatibility
for feature in $SELECTED_FEATURES; do
    check_feature_compatibility "$feature"
done

# Validate resource requirements
total_ram=$(calculate_total_ram_requirement)
if [[ $total_ram -gt $SYSTEM_RAM ]]; then
    warn "Insufficient RAM"
fi
```

### 3. Backup Phase

```bash
# Create timestamped backup
BACKUP_DIR="/etc/nixos/backups"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

mkdir -p "$BACKUP_DIR"
cp /etc/nixos/configuration.nix "$BACKUP_DIR/configuration-$TIMESTAMP.nix"
cp /etc/nixos/hypervisor-features.nix "$BACKUP_DIR/features-$TIMESTAMP.nix"
```

### 4. Generation Phase

The wizards generate new configuration files:

```nix
# Generated hypervisor-features.nix
{
  hypervisor.systemTier = "professional";
  
  hypervisor.featureManager = {
    enable = true;
    enabledFeatures = [
      "core"
      "libvirt"
      "monitoring"
      "ai-security"
      "web-dashboard"
    ];
    
    settings = {
      ai-security = {
        sensitivity = "balanced";
        updateInterval = "6h";
      };
    };
  };
  
  # Feature-specific NixOS configurations
  services.prometheus.enable = true;
  services.grafana.enable = true;
}
```

### 5. Integration Phase

The generated configuration is integrated into the system:

```bash
# Ensure imports are present in configuration.nix
if ! grep -q "hypervisor-features.nix" /etc/nixos/configuration.nix; then
    sed -i '/imports = \[/a\    ./hypervisor-features.nix' /etc/nixos/configuration.nix
fi
```

### 6. Testing Phase

```bash
# Dry run to test configuration
nixos-rebuild dry-build 2>&1 | tee /tmp/build-test.log

if [[ ${PIPESTATUS[0]} -eq 0 ]]; then
    echo "Configuration valid"
else
    echo "Configuration has errors"
    # Parse and display specific errors
fi
```

### 7. Application Phase

Based on user preference and settings:

#### Automatic Application (Auto-Switch Enabled)
```bash
# Apply immediately with detailed output
sudo nixos-rebuild switch --show-trace 2>&1 | tee -a "$LOG_FILE"
```

#### Manual Options
```bash
# Option 1: Apply on next boot
sudo nixos-rebuild boot

# Option 2: Build VM for testing
nixos-rebuild build-vm

# Option 3: Save for manual application
echo "Run 'sudo nixos-rebuild switch' when ready"
```

## 🎯 How Features Are Applied

### Feature to NixOS Configuration Mapping

Each feature translates to specific NixOS configurations:

| Feature | NixOS Configuration |
|---------|---------------------|
| `monitoring` | `services.prometheus.enable = true;`<br>`services.grafana.enable = true;` |
| `desktop-kde` | `services.xserver.enable = true;`<br>`services.xserver.desktopManager.plasma5.enable = true;` |
| `container-support` | `virtualisation.podman.enable = true;`<br>`virtualisation.podman.dockerCompat = true;` |
| `storage-zfs` | `boot.supportedFilesystems = ["zfs"];`<br>`services.zfs.autoScrub.enable = true;` |

### Module System Integration

Features can also enable custom modules:

```nix
# When "ai-security" is enabled
imports = [
  ./modules/security/ai-threat-detection.nix
  ./modules/security/behavioral-analysis.nix
];

hypervisor.security.ai = {
  enable = true;
  models = [ "anomaly-detection" "threat-classification" ];
};
```

## 🔒 Safety Mechanisms

### 1. Incompatibility Detection

Features that won't work are disabled with explanations:

```bash
# In wizard UI
✗ gpu-passthrough - GPU passthrough for VMs
  └─ IOMMU not enabled (required for GPU passthrough)

✗ storage-zfs - ZFS advanced filesystem  
  └─ Insufficient RAM: requires 1024MB, would exceed system capacity
```

### 2. Dependency Resolution

```bash
# Automatic dependency inclusion
if [[ " ${SELECTED_FEATURES[@]} " =~ " web-dashboard " ]]; then
    # web-dashboard requires monitoring
    if [[ ! " ${SELECTED_FEATURES[@]} " =~ " monitoring " ]]; then
        SELECTED_FEATURES+=("monitoring")
        echo "Added required dependency: monitoring"
    fi
fi
```

### 3. Rollback Capability

```bash
# If configuration fails
sudo cp "$BACKUP_DIR/configuration-$TIMESTAMP.nix" /etc/nixos/configuration.nix
sudo cp "$BACKUP_DIR/features-$TIMESTAMP.nix" /etc/nixos/hypervisor-features.nix
sudo nixos-rebuild switch
```

## 📊 State Management

### Configuration State Tracking

The system tracks:
- Current tier
- Enabled features
- Feature settings
- Last modification time
- Applied vs pending changes

### State Files

```bash
/var/lib/hypervisor/
├── state/
│   ├── current-tier
│   ├── enabled-features.json
│   └── last-applied.timestamp
├── cache/
│   └── system-detection.json
└── logs/
    └── feature-manager.log
```

## 🔄 Update Process

When features are modified:

1. **Compare** - Current vs desired state
2. **Plan** - Generate change set
3. **Validate** - Check all constraints
4. **Apply** - Implement changes
5. **Verify** - Confirm successful application

## 🛡️ Error Handling

### Common Error Scenarios

1. **Build Failures**
   ```bash
   error: undefined variable 'hypervisor'
   # Solution: Ensure all required modules are imported
   ```

2. **Resource Constraints**
   ```bash
   ERROR: Insufficient RAM (need 16384MB, have 8192MB)
   # Solution: Choose a lower tier or remove features
   ```

3. **Conflicts**
   ```bash
   ERROR: desktop-kde conflicts with desktop-gnome
   # Solution: Remove conflicting feature first
   ```

### Recovery Procedures

```bash
# Boot previous generation
# Select from GRUB menu at boot

# Or from command line
sudo nix-env --list-generations --profile /nix/var/nix/profiles/system
sudo nix-env --switch-generation <number> --profile /nix/var/nix/profiles/system
```

## 🔍 Debugging

### Enable Verbose Logging

```bash
# In wizard settings
AUTO_TEST=true
VERBOSE_LOGGING=true

# View logs
tail -f /var/log/hypervisor/feature-manager.log
journalctl -u hypervisor-system-detection -f
```

### Manual Testing

```bash
# Test specific feature compatibility
source /etc/hypervisor/detection-integration.sh
check_capability "cpu_virt"
get_hardware_info "ram_gb"

# Validate configuration manually
nix-instantiate --parse /etc/nixos/configuration.nix
nixos-rebuild dry-build --show-trace
```

## 📚 Best Practices

1. **Always Test First**
   - Use dry-build before applying
   - Test in VM for major changes

2. **Incremental Changes**
   - Add/remove few features at a time
   - Verify each change works

3. **Monitor Resources**
   - Check RAM usage after changes
   - Monitor service startup

4. **Document Custom Changes**
   - Keep notes on manual modifications
   - Document why features were enabled/disabled

## 🎛️ Advanced Configuration

### Custom Feature Definitions

```nix
# In custom-features.nix
hypervisor.customFeatures = {
  my-special-config = {
    enable = true;
    dependencies = [ "core" "networking-advanced" ];
    
    config = {
      services.myService = {
        enable = true;
        port = 8888;
      };
    };
  };
};
```

### Override Detection

```nix
# Force capabilities (use with caution)
hypervisor.systemDetection.capabilities = {
  cpu_virt = true;  # Override detection
  iommu_enabled = true;
};
```

## 📖 Related Documentation

- [Feature Management Guide](./FEATURE_MANAGEMENT_GUIDE.md)
- [System Tiers Documentation](./SYSTEM_TIERS.md)
- [NixOS Configuration Manual](https://nixos.org/manual/nixos/stable/)
- [Troubleshooting Guide](./TROUBLESHOOTING.md)