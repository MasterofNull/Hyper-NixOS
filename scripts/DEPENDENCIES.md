# Hyper-NixOS Script Dependencies

## Overview
This document maps dependencies between scripts, required commands, and system resources.

## Core Dependencies

### System Requirements
- **Operating System**: NixOS 23.11 or later
- **Shell**: Bash 4.0+
- **Privileges**: Root/sudo for system operations

### Required Commands
| Command | Package | Used By | Purpose |
|---------|---------|---------|---------|
| `bash` | bash | All scripts | Shell interpreter |
| `jq` | jq | Most scripts | JSON parsing |
| `virsh` | libvirt | VM scripts | VM management |
| `whiptail` | newt | Menu scripts | TUI dialogs |
| `dialog` | dialog | Menu scripts | Alternative TUI |
| `curl` | curl | Network scripts | HTTP operations |
| `git` | git | Update scripts | Version control |
| `nix` | nix | System scripts | Package management |
| `systemctl` | systemd | Service scripts | Service control |
| `mktemp` | coreutils | Many scripts | Temp file creation |
| `realpath` | coreutils | Path scripts | Path resolution |
| `bc` | bc | Calc scripts | Math operations |
| `awk` | gawk | Many scripts | Text processing |
| `sed` | gnused | Many scripts | Stream editing |
| `grep` | gnugrep | Many scripts | Pattern matching |
| `find` | findutils | Many scripts | File searching |

### Optional Commands
| Command | Package | Used By | Purpose |
|---------|---------|---------|---------|
| `shellcheck` | shellcheck | validate_scripts.sh | Syntax checking |
| `parallel` | parallel | bulk_operations.sh | Parallel execution |
| `pv` | pv | iso_manager.sh | Progress bars |
| `rsync` | rsync | migrate_vm.sh | File sync |
| `sshpass` | sshpass | ssh_setup.sh | SSH automation |
| `expect` | expect | automated scripts | Interaction automation |

## Script Call Graph

### Menu System
```
menu.sh (or menu/menu.sh)
├── lib/common.sh
├── lib/exit_codes.sh
├── lib/ui_common.sh
├── lib/vm_operations.sh
├── modules/vm_selector.sh
├── modules/system_menu.sh
├── modules/admin_menu.sh
├── create_vm_wizard.sh
├── iso_manager.sh
├── vm_dashboard.sh
├── install_vm_workflow.sh
├── system_installer.sh
├── diagnose.sh
├── donate.sh
└── Various other scripts...
```

### VM Management Scripts
```
create_vm_wizard.sh
├── lib/common.sh
├── json_to_libvirt_xml_and_define.sh
├── validate_profile.sh
└── hardware_detect.sh

vm_dashboard.sh
├── lib/common.sh
├── resource_reporter.sh
└── health_checks.sh

snapshots_backups.sh
├── lib/common.sh
├── automated_backup.sh
└── guided_backup_verification.sh
```

### System Installation
```
system_installer.sh
├── lib/common.sh
├── hardware_detect.sh
├── smart_sync_hypervisor.sh
├── validate_hypervisor_install.sh
└── rebuild_helper.sh

smart_sync_hypervisor.sh
├── lib/common.sh
└── Uses: curl, jq, git

dev_update_hypervisor.sh
├── validate_hypervisor_install.sh
├── smart_sync_hypervisor.sh
└── rebuild_helper.sh
```

### Automation Scripts
```
automated_backup.sh
├── lib/common.sh
└── Called by: systemd timer

health_monitor.sh
├── lib/common.sh
├── health_checks.sh
├── enhanced_health_checks.sh
└── alert_manager.sh

update_manager.sh
├── lib/common.sh
├── smart_sync_hypervisor.sh
└── rebuild_helper.sh
```

## File Dependencies

### Configuration Files
| File | Used By | Purpose |
|------|---------|---------|
| `/etc/hypervisor/config.json` | Most scripts | Global configuration |
| `/var/lib/hypervisor/vm-profiles/*.json` | VM scripts | VM definitions |
| `/etc/nixos/configuration.nix` | System scripts | NixOS config |
| `/etc/hypervisor/src/flake.nix` | Update scripts | Flake definition |

### State Files
| File | Used By | Purpose |
|------|---------|---------|
| `/var/lib/hypervisor/last_vm` | menu.sh | Last booted VM |
| `/var/lib/hypervisor/owner_filter` | menu.sh | Owner filtering |
| `/var/lib/hypervisor/.first_boot_done` | setup_wizard.sh | First boot flag |
| `/var/lib/hypervisor/logs/*.log` | All scripts | Log files |

### Generated Files
| File | Generated By | Purpose |
|------|----------|---------|
| `/tmp/hypervisor-*` | Various | Temporary files |
| `/var/lib/hypervisor/backups/*` | backup scripts | VM backups |
| `/var/lib/hypervisor/metrics-*.json` | monitoring | Metrics data |
| `/var/lib/hypervisor/isos/*` | iso_manager.sh | ISO images |

## Service Dependencies

### Systemd Services
| Script | Depends On Service | Provides Service |
|--------|-------------------|------------------|
| menu.sh | libvirtd.service | hypervisor-menu.service |
| health_monitor.sh | libvirtd.service | hypervisor-health-check.service |
| automated_backup.sh | libvirtd.service | hypervisor-backup.service |
| web_dashboard.py | libvirtd.service | hypervisor-web-dashboard.service |

### Network Dependencies
| Script | Network Requirement | Ports Used |
|--------|-------------------|------------|
| iso_manager.sh | Internet (downloads) | 80, 443 |
| update_manager.sh | Internet (GitHub) | 443 |
| smart_sync_hypervisor.sh | Internet (GitHub API) | 443 |
| web_dashboard.py | Localhost | 8080 |

## Module Dependencies

### NixOS Modules
Scripts that depend on specific NixOS module configurations:

| Script | Required Modules | Configuration |
|--------|-----------------|---------------|
| menu.sh | virtualization/libvirt.nix | libvirt enabled |
| vfio_workflow.sh | virtualization/performance.nix | VFIO settings |
| zone_manager.sh | network-settings/isolation.nix | Network zones |
| alert_manager.sh | monitoring/alerting.nix | Alert system |

## Error Handling Dependencies

All scripts should:
1. Source `lib/common.sh` for error handling
2. Source `lib/exit_codes.sh` for standardized exit codes
3. Use `set -Eeuo pipefail` for strict error handling
4. Implement cleanup handlers with `trap`

## Performance Considerations

### Heavy Scripts
These scripts may require significant resources:
- `automated_backup.sh` - Disk I/O intensive
- `vm_resource_optimizer.sh` - CPU intensive analysis
- `bulk_operations.sh` - Multiple VM operations
- `security_audit.sh` - System-wide scanning

### Parallelizable Scripts
These scripts benefit from parallel execution:
- `bulk_operations.sh` - Process multiple VMs
- `health_checks.sh` - Check multiple services
- `resource_reporter.sh` - Gather multiple metrics

## Security Dependencies

### Scripts Requiring Root
Must be run with sudo/root:
- `system_installer.sh`
- `hardware_detect.sh`
- `foundational_networking_setup.sh`
- `security_audit.sh`
- `harden_permissions.sh`
- `update_hypervisor.sh`

### Scripts with Security Implications
Handle sensitive data:
- `ssh_setup.sh` - SSH keys
- `automated_backup.sh` - VM data
- `migrate_vm.sh` - VM migration
- `per_vm_firewall.sh` - Firewall rules

## Testing Dependencies

### Scripts with Test Coverage
| Script | Test File | Coverage |
|--------|-----------|----------|
| lib/common.sh | tests/unit/test_common.sh | Functions |
| lib/exit_codes.sh | tests/unit/test_common.sh | Exit codes |
| menu/menu.sh | tests/integration/test_menu.sh | Menu flow |

### Scripts Needing Tests
High priority for test coverage:
- `create_vm_wizard.sh`
- `json_to_libvirt_xml_and_define.sh`
- `automated_backup.sh`
- `smart_sync_hypervisor.sh`

## Maintenance Notes

### Deprecated Scripts
Scripts planned for removal or replacement:
- `menu.sh` (replaced by `menu/menu.sh`)
- `rest_api_stub.sh` (prototype only)

### Scripts Under Development
May have incomplete functionality:
- `interactive_tutorial.sh`
- `cloud_init_seed.sh`
- `guest_agent_actions.sh`

## Dependency Installation

To ensure all dependencies are available:

```bash
# Install required packages (NixOS)
nix-env -iA nixos.jq nixos.libvirt nixos.newt nixos.curl nixos.git

# Install optional packages
nix-env -iA nixos.shellcheck nixos.parallel nixos.pv nixos.rsync

# Verify dependencies
scripts/validate_scripts.sh --check-deps
```