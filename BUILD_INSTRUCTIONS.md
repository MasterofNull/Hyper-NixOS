# Build Instructions for Hyper-NixOS

## Repository Architecture

Hyper-NixOS is a flake-based NixOS system with the following structure:

```
Hyper-NixOS/
├── flake.nix                    # Entry point - defines nixosConfigurations
├── flake.lock                   # Locked dependency versions
├── configuration.nix            # Main config - imports all modules
├── hardware-configuration.nix   # Placeholder (no-op in repository)
├── modules/                     # All NixOS modules
│   ├── core/
│   ├── hardware/
│   ├── security/
│   ├── features/
│   └── ...
├── profiles/                    # Alternative configuration profiles
├── scripts/                     # Automation and management scripts
├── docs/                        # Documentation
└── tests/                       # Test suites
```

---

## Standard Build Commands

### Building from Repository

```bash
# Navigate to repository
cd /home/hyperd/Documents/Hyper-NixOS

# Test configuration syntax (fast)
sudo nixos-rebuild dry-build --flake .

# Build without activating
sudo nixos-rebuild build --flake .

# Build and activate temporarily (reverts on reboot)
sudo nixos-rebuild test --flake .

# Build and activate permanently
sudo nixos-rebuild switch --flake .
```

### Understanding the --flake Flag

The `--flake .` flag tells NixOS to:
1. Use the `flake.nix` in current directory (`.`)
2. Automatically detect your hostname
3. Build the matching configuration (e.g., `hypervisor-x86_64`)

**Explicit configuration selection**:
```bash
# Specify configuration explicitly
sudo nixos-rebuild switch --flake .#hypervisor-x86_64
sudo nixos-rebuild switch --flake .#hypervisor-aarch64
```

---

## Development Workflow

### Making Changes

```bash
# 1. Edit files in repository
vim modules/security/something.nix

# 2. Test syntax
sudo nixos-rebuild dry-build --flake .

# 3. Build (creates ./result symlink)
sudo nixos-rebuild build --flake .

# 4. Review what changed
ls -l ./result
nix-diff /run/current-system ./result

# 5. Apply changes
sudo nixos-rebuild switch --flake .

# 6. Commit changes
git add -A
git commit -m "describe changes"
git push
```

### Testing Configuration Changes Safely

```bash
# Option 1: Test mode (reverts on reboot)
sudo nixos-rebuild test --flake .
# Try it out - if broken, just reboot to previous config

# Option 2: Build and review
sudo nixos-rebuild build --flake .
# Check ./result before applying
sudo nixos-rebuild switch --flake .
```

---

## Common Workflows

### Update System Packages

```bash
cd Hyper-NixOS

# Update flake inputs (nixpkgs, etc.)
nix flake update

# Review changes
git diff flake.lock

# Apply updates
sudo nixos-rebuild switch --flake .
```

### Switch NixOS Channels

```bash
cd Hyper-NixOS

# Use the channel switcher script
./scripts/switch-channel.sh

# Or manually edit flake.nix
vim flake.nix
# Change: nixpkgs.url = "github:NixOS/nixpkgs/nixos-XX.YY";

# Update and rebuild
nix flake update
sudo nixos-rebuild switch --flake .
```

### Use Alternative Configuration Profiles

The repository includes multiple configuration profiles:

```bash
# Minimal configuration
sudo nixos-rebuild switch --flake .#minimal

# Complete with all features
sudo nixos-rebuild switch --flake .#complete

# Recovery configuration
sudo nixos-rebuild switch --flake .#minimal-recovery
```

Check `profiles/` directory for all available profiles.

---

## Hardware Configuration

### The hardware-configuration.nix File

**In Repository**: `hardware-configuration.nix` is a placeholder (no-op)

**On Installed Systems**: Gets replaced with auto-generated hardware detection:
```nix
# Generated by nixos-generate-config
{
  boot.initrd.availableKernelModules = [ "nvme" "xhci_pci" ... ];
  boot.kernelModules = [ "kvm-amd" ];
  fileSystems."/" = { device = "/dev/disk/by-uuid/..."; };
  # ... hardware-specific settings
}
```

### Regenerating Hardware Configuration

If you change hardware (new disk, CPU, etc.):

```bash
# Generate new hardware config
sudo nixos-generate-config --show-hardware-config > hardware-configuration.nix

# Review changes
git diff hardware-configuration.nix

# Test build
sudo nixos-rebuild dry-build --flake .

# Apply if looks good
sudo nixos-rebuild switch --flake .
```

---

## Installation

### Initial System Installation

The system installer copies the repository and sets up the system:

```bash
# From live USB/ISO
sudo ./scripts/system_installer.sh

# Or use the flake app
nix run .#system-installer
```

The installer will:
1. Copy repository to installation location
2. Generate hardware configuration
3. Configure bootloader
4. Build and install system

### Manual Installation

```bash
# 1. Partition and mount
# (follow NixOS installation guide)

# 2. Generate hardware config
nixos-generate-config --root /mnt

# 3. Copy Hyper-NixOS to install location
sudo mkdir -p /mnt/etc/nixos
sudo cp -r Hyper-NixOS/* /mnt/etc/nixos/

# 4. Copy hardware config
sudo cp /mnt/etc/nixos/hardware-configuration.nix /mnt/etc/nixos/hardware-configuration.nix

# 5. Install
sudo nixos-install --flake /mnt/etc/nixos#hypervisor-x86_64
```

---

## Troubleshooting

### Error: "option does not exist"

**Cause**: Module not imported in configuration.nix

**Fix**: Check that all modules are imported in `configuration.nix`

```bash
grep -r "options.hypervisor.module.name" modules/
# Find which module defines the option

grep "module.name" configuration.nix
# Check if module is imported
```

### Error: "infinite recursion"

**Cause**: Incorrect module pattern (top-level config access)

**Fix**: Ensure modules follow correct pattern:

```nix
# ❌ WRONG
let
  cfg = config.hypervisor.something;
in { ... }

# ✅ CORRECT
{
  config = lib.mkIf condition (let
    cfg = config.hypervisor.something;
  in { ... });
}
```

See `docs/dev/AI-LESSONS-LEARNED.md` for details.

### Build Fails with No Error

**Cause**: May need --show-trace for details

**Fix**:
```bash
sudo nixos-rebuild build --flake . --show-trace
```

### Changes Not Applied

**Cause**: Building from wrong directory or old flake cache

**Fix**:
```bash
# Ensure in repository directory
cd /home/hyperd/Documents/Hyper-NixOS
pwd  # Should show: /home/hyperd/Documents/Hyper-NixOS

# Clear flake cache if needed
nix flake lock --update-input nixpkgs

# Rebuild
sudo nixos-rebuild switch --flake .
```

---

## Architecture Reference

### Build Flow

```
flake.nix
  ↓
nixosConfigurations.hypervisor-x86_64
  ↓
modules = [ ./configuration.nix ]
  ↓
configuration.nix
  ├→ ./hardware-configuration.nix
  └→ ./modules/**/*.nix (all modules)
```

### Configuration Locations

**Development**: `/home/hyperd/Documents/Hyper-NixOS/`
- Source of truth
- Version controlled with git
- Where all development happens

**After Installation**: Varies by installation method
- System builds from installed repository location
- Uses same `flake.nix` → `configuration.nix` structure

---

## Quick Reference

| Task | Command |
|------|---------|
| Test syntax | `sudo nixos-rebuild dry-build --flake .` |
| Build only | `sudo nixos-rebuild build --flake .` |
| Test (temporary) | `sudo nixos-rebuild test --flake .` |
| Apply changes | `sudo nixos-rebuild switch --flake .` |
| Update packages | `nix flake update && sudo nixos-rebuild switch --flake .` |
| Switch channel | `./scripts/switch-channel.sh` |
| Use profile | `sudo nixos-rebuild switch --flake .#profile-name` |
| Show hardware | `nixos-generate-config --show-hardware-config` |

---

## Additional Resources

- **Architecture**: See `docs/dev/DEVELOPMENT_REFERENCE.md`
- **Module Development**: See `docs/dev/AI-LESSONS-LEARNED.md`
- **Security**: See `docs/SECURITY.md`
- **Troubleshooting**: See `docs/TROUBLESHOOTING.md`
- **Installation**: See `docs/INSTALLATION_GUIDE.md`

---

**Last Updated**: 2025-10-19
**NixOS Version**: 25.05
**Architecture**: Flake-based
